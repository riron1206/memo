<html>
<head>
  <title>Evernote Export</title>
  <basefont face="メイリオ" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308919 (ja-JP, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: メイリオ;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3288"/>

<div>
<span><div><div><span style="font-size: 10pt; font-weight: bold;">■Oracle SQLの基本ルール</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 「SELECT *」を使用せず、列名を明記する。*だとメンテナンス性にかけるため</span></div><div><span style="font-size: 10pt;">SELECT A.name, A.price FROM TBL A;</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># INSERT句でINTO後の列名を省略せずに明記する。列名なしだとメンテナンス性にかけるため</span></div><div><span style="font-size: 10pt;">INSERT INTO</span></div><div><span style="font-size: 10pt;">    goods(id, name)</span></div><div><span style="font-size: 10pt;">VALUES</span></div><div><span style="font-size: 10pt;">    (01, 'A');</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># AND/ORの演算子やカンマは行頭に揃える。テーブル名はエイリアス（省略名）で扱う</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    t.name</span></div><div><span style="font-size: 10pt;">    , t.id</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">    tabel t;</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># テーブル結合はJOIN-ONで行う。WHEREでもできるが検索条件と勘違いしやすいので</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    *</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">    table_A a</span></div><div><span style="font-size: 10pt;">    INNER JOIN</span></div><div><span style="font-size: 10pt;">        table_B b</span></div><div><span style="font-size: 10pt;">    ON</span></div><div><span style="font-size: 10pt;">        a.id = b.id</span></div><div><span style="font-size: 10pt;">WHERE</span></div><div><span style="font-size: 10pt;">    a.id = '01';</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 特定のテーブルについて、条件が一致すればレコードアップデート、一致しなければインサートしたい場合はMERGE文を使う</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 条件分岐はCASE文使う</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 検索条件はコマンドラインでパラメータ渡しできる（らしい）</span></div><div><span style="font-size: 10pt;">tmp.sql:</span></div><div><span style="font-size: 10pt;">SELECT * FROM table t WHERE t.id = '%1' AND t.id = '%2';</span></div><div><span style="font-size: 10pt;">SQL&gt;$ tmp.sql 1 2 # %1に1, %2に2がはいる</span></div><div><font style="font-size: 10pt;"><br/></font></div><hr/><div><span style="font-size: 10pt; font-weight: bold;">■ Oracle SQLの性能劣化避けるTips</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># レコード多いテーブルにはindexを貼る</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># WHERE句はできるだけindexついてる列で行う</span></div><div><span style="font-size: 10pt;">SELECT * FROM table AS t WHERE code IN ['12', '32'] AND date &lt;= '2016-10-13' -- code列はindexついてるものとしたとき</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># レコード多いテーブルアクセスを避ける</span></div><div><span style="font-size: 10pt;">→レコード多いテーブルのSELECTや検索や副問い合わせ、集計関数、CASE文、ソート(ORDER BY)を減らす</span></div><div><span style="font-size: 10pt;">→レコード多いテーブル同士の結合（JOIN-ON）やUNIONを減らす</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># ソートが入るSQLは避ける</span></div><div><span style="font-size: 10pt;">→DISTINCTを多用しない    （暗黙的ソートと重複削除が発生）</span></div><div><span style="font-size: 10pt;">→UNIONを多用しない    (テーブル縦積みで暗黙的ソートと重複削除が発生。UNION ALLなら暗黙的ソートのみ)</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 検索、結合条件で列に対しては演算、関数は使用しない。列に対しての演算などはindex適用されないので、定数に演算すること</span></div><div><span style="font-size: 10pt;">OK:SELECT * FROM table t WHERE t.price = 1*10;</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;"># 「!=」「&lt;&gt;」「NOT LIKE」はindex使われないので避ける（</span><span style="font-size: 10pt; font-weight: bold;">列に対しての演算などはindex適用されないので</span><span style="font-size: 10pt; font-weight: bold;">）</span></font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 複数の条件一致はIN (,)を使う。INの(,)の要素は1000件が上限なので、100件ぐらいまでにしておく。</span></div><div><span style="font-size: 10pt;">SELECT * FROM table t WHERE t.id IN (1, 99);</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 複数列で検索条件ある場合は、OR条件を（）でくくると、()外の列はindex活用される。下の例だとprice列はindex使う</span></div><div><span style="font-size: 10pt;">SELECT * FROM table t WHERE t.price AND (t.id = 0 OR t.id = 99);</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># LIKEは前方一致だけ使う。中間(LIKE '%a%')、後方一致(LIKE '%aaa')はindex使わない</span><span style="font-size: 10pt;">。</span></div><div><span style="font-size: 10pt;">SELECT * FROM table t WHERE t.name LIKE 'aaa%';</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 副問い合わせを結合(JOIN-ON)に変換する。結合のほうが高速なので</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;"># 副問い合わせ（SQL文のなかに別のSQL文書くこと）はFROMに書く。SELECTに書くと検索ごとに副問い合わせが発生して</span><span style="font-size: 10pt; font-weight: bold;">遅くなる</span></font></div><div><span style="font-size: 10pt;">OK:SELECT * FROM (SELECT t.a, t.b FROM table) tmp;</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># 副問い合わせ多いと遅くなるので、共通化できる副問い合わせはWITH句で一時テーブルにする。</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;"># ビュー同士の結合、ビューを使用した副問い合わせはしない。ビューは実態が無いのでビュー呼ぶ出すたびビュー定義クエリが実行されて時間かかる</span></div><div><font style="font-size: 10pt;"><br/></font></div><hr/><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">■</span><span style="font-size: 10pt; font-weight: bold;">sqlite</span></font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# sqliteでのDB作成手順</span></div><div><span style="font-size: 10pt; font-weight: bold;">-- 1.DB_Browser_for_SQLiteでdbファイル作成してから、Execute SQLタブからCREATE TABLE …のSQL実行</span></div><div><span style="font-size: 10pt; font-weight: bold;">-- もしくはDDL書いたsqlファイルコマンドラインから実行</span></div><div><span style="font-size: 10pt;">$ activate stock</span></div><div><span style="font-size: 10pt;">$ sqlite3 C:\Users\shingo\Git\awesomebook\work_sqlite\work.db &lt; ./sqlite_ddl.sql</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">-- 2.テーブル作成後、以下のコマンドでcsvインポート</span><span style="font-size: 10pt;">(</span><a href="https://qiita.com/Kunikata/items/61b5ee2c6a715f610493" style="font-size: 10pt;">https://qiita.com/Kunikata/items/61b5ee2c6a715f610493</a> <span style="font-size: 10pt;">より)</span></div><div><span style="font-size: 10pt; font-weight: bold;">-- ※csvファイルは1行目にヘッダがあるなら削除すること。削除しておかないとデータとして取り込まれる</span></div><div><span style="font-size: 10pt;">$ cd C:\Users\shingo\Git\awesomebook\data</span></div><div><span style="font-size: 10pt;">$ activate stock</span></div><div><span style="font-size: 10pt;">$ sqlite3 -separator , C:\Users\shingo\Git\awesomebook\work_sqlite\work.db &quot;.import reserve.csv reserve_tb&quot;</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><br/></font></div><hr/><div><span style="font-size: 10pt; font-weight: bold;">■SQL例</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# ランダムサンプリング</span></div><div><span style="font-size: 10pt;">SELECT *</span></div><div><span style="font-size: 10pt;">FROM work.tb</span></div><div><span style="font-size: 10pt;">ORDER BY RANDOM() -- レコードごとに乱数生成して昇順ソート</span></div><div><span style="font-size: 10pt;">LIMIT ROUND(12000 * 0.5) -- 事前にカウントしたレコード数*抽出する割合で取るレコード数制限</span></div><div><span style="font-size: 10pt;">もしくは</span></div><div><span style="font-size: 10pt;">SELECT *</span></div><div><span style="font-size: 10pt;">FROM work.tb</span></div><div><span style="font-size: 10pt;">WHERE RANDOM() &lt;= 0.5 -- 乱数0.5以下のレコードだけ抽出</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 集計ID単位のサンプリング</span><span style="font-size: 10pt; font-weight: bold;">（sqliteでは</span><span style="font-size: 10pt; font-weight: bold;">FIRST_VALUE使えないからエラーになるが</span><span style="font-size: 10pt; font-weight: bold;">）</span></font></div><div><span style="font-size: 10pt;">WITH tbl AS(</span></div><div><span style="font-size: 10pt;">    SELECT *, FIRST_VALUE(RANDOM()) OVER (PARTITION BY id) AS random_num</span></div><div><span style="font-size: 10pt;">    FROM tmp_tbl</span></div><div><span style="font-size: 10pt;">)</span></div><div><span style="font-size: 10pt;">SELECT *</span></div><div><span style="font-size: 10pt;">FROM tbl</span></div><div><span style="font-size: 10pt;">WHERE tmp_tbl &lt;= 0.5</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 集約</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    customer_id,</span></div><div><span style="font-size: 10pt;">    COUNT(customer_id) AS id_cnt,</span></div><div><span style="font-size: 10pt;">    COUNT(distinct customer_id) as id_dict_cnt</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><span style="font-size: 10pt;">GROUP BY customer_id</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 合計</span></div><div><span style="font-size: 10pt;">SELECT reserve_id, SUM(total_price)</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><span style="font-size: 10pt;">GROUP BY reserve_id</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 統計値（sqliteではMAX,MIN,AVGしか出せないが）</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  hotel_id,</span></div><div><span style="font-size: 10pt;">  MAX(total_price) AS price_max,  -- total_priceの最大値を算出</span></div><div><span style="font-size: 10pt;">  MIN(total_price) AS price_min,  -- total_priceの最小値を算出</span></div><div><span style="font-size: 10pt;">  AVG(total_price) AS price_avg,  -- total_priceの平均値を算出</span></div><div><span style="font-size: 10pt;">  MEDIAN(total_price) AS price_med,  -- total_priceの中央値を算出</span></div><div><span style="font-size: 10pt;">  PERCENTILE_CONT(0.2) WITHIN GROUP(ORDER BY total_price) AS price_20per  -- PERCENTILE_CONT関数に0.2を指定し、20パーセントタイル値を算出</span></div><div><span style="font-size: 10pt;">FROM work.reserve_tb</span></div><div><span style="font-size: 10pt;">GROUP BY hotel_id</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 分散と標準偏差</span><span style="font-size: 10pt; font-weight: bold;">（sqliteで</span><span style="font-size: 10pt; font-weight: bold;">VARIANCE,</span><span style="font-size: 10pt; font-weight: bold;">STDDEV</span><span style="font-size: 10pt; font-weight: bold;">出せないが）</span></font></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  hotel_id,</span></div><div><span style="font-size: 10pt;">  COALESCE(VARIANCE(total_price), 0) AS price_var,  -- VARIANCE関数にtotal_priceを指定し、分散値を算出、COALESCE関数によって、分散値がNULLのときは0に変換</span></div><div><span style="font-size: 10pt;">  COALESCE(STDDEV(total_price), 0) AS price_std  -- データ数が2件以上の場合は、STDDEV関数にtotal_priceを指定し、標準偏差値を算出</span></div><div><span style="font-size: 10pt;">FROM work.reserve_tb</span></div><div><span style="font-size: 10pt;">GROUP BY hotel_id</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 最頻値</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  ROUND(total_price, -3) AS total_price_round  -- Round関数によって四捨五入し、total_priceを1000単位の値に変換</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><span style="font-size: 10pt;">GROUP BY total_price_round</span></div><div><span style="font-size: 10pt;">ORDER BY COUNT(*) DESC  -- COUNT関数で算出した金額別の予約数を大きい順に並び替え(DESCを付けると昇順)</span></div><div><span style="font-size: 10pt;">LIMIT 1  -- LIMIT句で最初の1件のみ結果を取得</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 行番号列を作る</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  *,</span></div><div><span style="font-size: 10pt;">  -- ROW_NUMBERで順位を取得</span></div><div><span style="font-size: 10pt;">  -- PARTITION by customer_idで顧客ごとに順位を取得するよう設定</span></div><div><span style="font-size: 10pt;">  -- ORDER BY reserve_datetimeで順位を予約日時の古い順に設定</span></div><div><span style="font-size: 10pt;">  ROW_NUMBER()</span></div><div><span style="font-size: 10pt;">    OVER (PARTITION BY customer_id ORDER BY reserve_datetime) AS log_no</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 順位列を作る</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  hotel_id,</span></div><div><span style="font-size: 10pt;">  -- RANK関数で予約数の順位を指定</span></div><div><span style="font-size: 10pt;">  -- COUNT(*)をRANKの基準として指定(集約したあとの予約数に対して順位を付ける算出処理)</span></div><div><span style="font-size: 10pt;">  -- DESCを付けることによって、降順を指定</span></div><div><span style="font-size: 10pt;">  RANK() OVER (ORDER BY COUNT(*) DESC) AS rsv_cnt_rank</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><span style="font-size: 10pt;">-- hotel_idを集約単位に指定、予約数を計算するための集約指定でRANK関数には関係なし</span></div><div><span style="font-size: 10pt;">GROUP BY hotel_id</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# n件前のデータ取得</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    *,</span></div><div><span style="font-size: 10pt;">    -- LAG関数を利用し、2件前のtotal_priceをbefore_priceとして取得</span></div><div><span style="font-size: 10pt;">    -- LAG関数によって参照する際のグループをcustomer_idに指定</span></div><div><span style="font-size: 10pt;">    -- LAG関数によって参照する際のグループ内のデータをreserve_datetimeの古い順に指定</span></div><div><span style="font-size: 10pt;">  LAG(total_price, 2) OVER</span></div><div><span style="font-size: 10pt;">    (PARTITION BY customer_id ORDER BY reserve_datetime) AS before_price</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 過去n件の合計値</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  *,</span></div><div><span style="font-size: 10pt;">  CASE WHEN</span></div><div><span style="font-size: 10pt;">    -- COUNT関数で何件の合計を計算したかをカウントし、3件あるのかを判定</span></div><div><span style="font-size: 10pt;">        -- BETWEEN句で2件前から</span></div><div><span style="font-size: 10pt;">      COUNT(total_price) OVER</span></div><div><span style="font-size: 10pt;">        (PARTITION BY customer_id ORDER BY reserve_datetime ROWS</span></div><div><span style="font-size: 10pt;">         BETWEEN 2 PRECEDING AND CURRENT ROW) = 3</span></div><div><span style="font-size: 10pt;">  THEN</span></div><div><span style="font-size: 10pt;">    -- 自身を含めた3件の合計金額を計算</span></div><div><span style="font-size: 10pt;">      SUM(total_price) OVER</span></div><div><span style="font-size: 10pt;">        (PARTITION BY customer_id ORDER BY reserve_datetime ROWS</span></div><div><span style="font-size: 10pt;">         BETWEEN 2  PRECEDING AND CURRENT ROW)</span></div><div><span style="font-size: 10pt;">  ELSE NULL END AS price_sum</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 過去n件の平均</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  *,</span></div><div><span style="font-size: 10pt;">  AVG(total_price) OVER</span></div><div><span style="font-size: 10pt;">    (PARTITION BY customer_id ORDER BY checkin_date ROWS</span></div><div><span style="font-size: 10pt;">     BETWEEN 3 PRECEDING AND 1 PRECEDING) AS price_avg</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 過去n日間の合計値</span><span style="font-size: 10pt; font-weight: bold;">（sqliteでは実行できず</span><span style="font-size: 10pt; font-weight: bold;">）</span></font></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  base.*,  -- 結合元のデータ列をすべて取得</span></div><div><span style="font-size: 10pt;">  COALESCE(SUM(combine.total_price), 0) AS price_sum  -- 対象の件数が0件の場合は0、1件以上ある場合は合計金額を計算</span></div><div><span style="font-size: 10pt;">FROM work.reserve_tb base  -- 結合元の予約テーブルの指定</span></div><div><span style="font-size: 10pt;">-- 過去の情報として結合する予約テーブルの指定</span></div><div><span style="font-size: 10pt;">LEFT JOIN work.reserve_tb combine</span></div><div><span style="font-size: 10pt;">  ON base.customer_id = combine.customer_id  -- 同じcustomer_id同士で結合</span></div><div><span style="font-size: 10pt;">  AND base.reserve_datetime &gt; combine.reserve_datetime</span></div><div><span style="font-size: 10pt;">  AND DATEADD(day, -90, base.reserve_datetime) &lt;= combine.reserve_datetime  -- 90日前までの過去のデータのみを結合対象として指定</span></div><div><span style="font-size: 10pt;">-- 結合元の予約テーブルのすべてのデータ列で集約</span></div><div><span style="font-size: 10pt;">GROUP BY base.reserve_id, base.hotel_id, base.customer_id,</span></div><div><span style="font-size: 10pt;">  base.reserve_datetime, base.checkin_date, base.checkin_time, base.checkout_date,</span></div><div><span style="font-size: 10pt;">  base.people_num, base.total_price</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 結合</span></font></div><div><span style="font-size: 10pt;">SELECT *</span></div><div><span style="font-size: 10pt;">FROM reserve_tb AS rsv</span></div><div><span style="font-size: 10pt;">JOIN hotel_tb AS hotel</span></div><div><span style="font-size: 10pt;">  ON rsv.hotel_id = hotel.hotel_id</span></div><div><span style="font-size: 10pt;">WHERE hotel.is_business IS True</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 全結合:</span><span style="font-size: 10pt; font-weight: bold;">cross join</span><span style="font-size: 10pt; font-weight: bold;">（全てのコンビネーションの行の結果セットを取得する。 [ 左のテーブルのレコード数 ] x [ 右のテーブルのレコード数 ] になる）処理</span><span style="font-size: 10pt; font-weight: bold;">（sqliteでは実行できず</span><span style="font-size: 10pt; font-weight: bold;">）</span></font></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    cus.customer_id,</span></div><div><span style="font-size: 10pt;">    mst.year_num,  -- 年月マスタから年を取得</span></div><div><span style="font-size: 10pt;">    mst.month_num,  -- 年月マスタから月を取得</span></div><div><span style="font-size: 10pt;">    SUM(COALESCE(rsv.total_price, 0)) AS total_price_month  -- 該当のtotal_priceがある場合は足し合わせ、ない場合は0を足し合わせる</span></div><div><span style="font-size: 10pt;">FROM work.customer_tb cus</span></div><div><span style="font-size: 10pt;">CROSS JOIN work.month_mst mst  -- 顧客テーブルと年月マスタと全結合</span></div><div><span style="font-size: 10pt;">-- 顧客テーブルと年月マスタと予約テーブルを結合</span></div><div><span style="font-size: 10pt;">LEFT JOIN work.reserve_tb rsv</span></div><div><span style="font-size: 10pt;">  ON cus.customer_id = rsv.customer_id</span></div><div><span style="font-size: 10pt;">    AND mst.month_first_day &lt;= rsv.checkin_date</span></div><div><span style="font-size: 10pt;">    AND mst.month_last_day &gt;= rsv.checkin_date</span></div><div><span style="font-size: 10pt;">-- 年月マスタの対象期間を絞り込み</span></div><div><span style="font-size: 10pt;">WHERE mst.month_first_day &gt;= '2017-01-01'</span></div><div><span style="font-size: 10pt;">  AND mst.month_first_day &lt; '2017-04-01'</span></div><div><span style="font-size: 10pt;">GROUP BY cus.customer_id, mst.year_num, mst.month_num</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">-- # 数値型へ変換</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  -- 整数型へ変換 40000/3と記述すると整数型として計算され、少数点以下が計算されない</span></div><div><span style="font-size: 10pt;">  CAST((40000.0 / 3) AS INT2) AS v_int2,</span></div><div><span style="font-size: 10pt;">  CAST((40000.0 / 3) AS INT4) AS v_int4,</span></div><div><span style="font-size: 10pt;">  CAST((40000.0 / 3) AS INT8) AS v_int8,</span></div><div><span style="font-size: 10pt;">  -- 浮動小数点型へ変換</span></div><div><span style="font-size: 10pt;">  CAST((40000.0 / 3) AS FLOAT4) AS v_float4,</span></div><div><span style="font-size: 10pt;">  CAST((40000.0 / 3) AS FLOAT8) AS v_float8</span></div><div><span style="font-size: 10pt;">-- テーブルのデータは関係ないですが、上記を計算するために指定</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><span style="font-size: 10pt;">LIMIT 1</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 対数化（log10掛ける）</span><span style="font-size: 10pt; font-weight: bold;">（sqliteではLOG()が無いのか実行できず</span><span style="font-size: 10pt; font-weight: bold;">）</span></font></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    *,</span></div><div><span style="font-size: 10pt;">  LOG(total_price / 1000 + 1) AS total_price_log -- total_priceを1000で割り、1足した結果を対数化</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 数値列のカテゴリ化</span><span style="font-size: 10pt; font-weight: bold;">（sqliteでは</span><span style="font-size: 10pt; font-weight: bold;">FLOOR</span><span style="font-size: 10pt; font-weight: bold;">()が無いのか実行できず</span><span style="font-size: 10pt; font-weight: bold;">）</span></font></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    *,</span></div><div><span style="font-size: 10pt;">    FLOOR(age / 10) * 10 AS age_rank  -- 10刻みの値に変更。FLOORは小数点以下を切り捨てる</span></div><div><span style="font-size: 10pt;">FROM customer_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 欠損レコード削除</span></div><div><span style="font-size: 10pt;">SELECT *</span></div><div><span style="font-size: 10pt;">FROM production_missn_tb</span></div><div><span style="font-size: 10pt;">WHERE thickness is not NULL  -- thicknessがnullのレコードを削除</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 欠損レコード定数で置き換え</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  type,</span></div><div><span style="font-size: 10pt;">  length,</span></div><div><span style="font-size: 10pt;">  COALESCE(thickness, 1) AS thickness,  -- thicknessの欠損値を1で補完</span></div><div><span style="font-size: 10pt;">  fault_flg</span></div><div><span style="font-size: 10pt;">FROM production_missn_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 平均値補完</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  type,</span></div><div><span style="font-size: 10pt;">  length,</span></div><div><span style="font-size: 10pt;">  COALESCE(thickness, (SELECT AVG(thickness) FROM production_missn_tb)) AS thickness,</span></div><div><span style="font-size: 10pt;">  fault_flg</span></div><div><span style="font-size: 10pt;">FROM production_missn_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 性別列をTRUE/FALSEに置き換えたカテゴリ列作成</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  CASE WHEN sex = 'man' THEN TRUE ELSE FALSE END AS sex_is_man</span></div><div><span style="font-size: 10pt;">FROM customer_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# カテゴリ値の集約（データ数が少ないカテゴリを1つにまとめる）</span><span style="font-size: 10pt; font-weight: bold;">（sqliteでは</span><span style="font-size: 10pt; font-weight: bold;">FLOOR</span><span style="font-size: 10pt; font-weight: bold;">()が無いのか実行できず</span><span style="font-size: 10pt; font-weight: bold;">）</span></font></div><div><span style="font-size: 10pt;">WITH customer_tb_with_age_rank AS(</span></div><div><span style="font-size: 10pt;">  SELECT</span></div><div><span style="font-size: 10pt;">    *,</span></div><div><span style="font-size: 10pt;">    CAST(FLOOR(age / 10) * 10 AS TEXT) AS age_rank  -- 年齢を10才区切りでカテゴリ化</span></div><div><span style="font-size: 10pt;">  FROM customer_tb</span></div><div><span style="font-size: 10pt;">)</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  customer_id, age, sex, home_latitude, home_longitude,</span></div><div><span style="font-size: 10pt;">  CASE WHEN age_rank = '60' OR age_rank = '70' OR age_rank = '80'</span></div><div><span style="font-size: 10pt;">    THEN '60才以上' ELSE age_rank END AS age_rank  -- カテゴリを集約</span></div><div><span style="font-size: 10pt;">FROM customer_tb_with_age_rank</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# カテゴリ変数の組み合わせ</span><span style="font-size: 10pt; font-weight: bold;">（sqliteでは</span><span style="font-size: 10pt; font-weight: bold;">FLOOR</span><span style="font-size: 10pt; font-weight: bold;">()が無いのか実行できず</span><span style="font-size: 10pt; font-weight: bold;">）</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  *,</span></div><div><span style="font-size: 10pt;">  sex || '_' || CAST(FLOOR(age / 10) * 10 AS TEXT) AS sex_and_age  -- sexと年齢の10才区切りのカテゴリ値を文字列として間に&quot;_&quot;を加えて結合</span></div><div><span style="font-size: 10pt;">FROM customer_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 日時型、日付型に変換</span><span style="font-size: 10pt; font-weight: bold;">（sqliteでは</span><b><span style="font-size: 10pt;">TO_DATE()や</span><span style="font-size: 10pt;">T</span></b><span style="font-size: 10pt; font-weight: bold;">O_TIMESTAMP()とか無いから?</span><span style="font-size: 10pt; font-weight: bold;">実行できず</span><span style="font-size: 10pt; font-weight: bold;">）</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">  TO_TIMESTAMP(reserve_datetime, 'YYYY-MM-DD HH24:MI:SS') AS reserve_datetime_timestamptz,  -- timestamptzに変換</span></div><div><span style="font-size: 10pt;">  CAST(TO_TIMESTAMP(reserve_datetime, 'YYYY-MM-DD HH24:MI:SS') AS TIMESTAMP) AS reserve_datetime_timestamp,  -- timestamptzに変換後に、timestampに変換</span></div><div><span style="font-size: 10pt;">  TO_TIMESTAMP(checkin_date || checkin_time, 'YYYY-MM-DDHH24:MI:SS') AS checkin_timestamptz,  -- 日付と時刻の文字結合してから、TIMESTAMPに変換</span></div><div><span style="font-size: 10pt;">  TO_DATE(reserve_datetime, 'YYYY-MM-DD HH24:MI:SS') AS reserve_date,  -- 日時文字列を日付型に変換（時刻情報は変換後削除されている）</span></div><div><span style="font-size: 10pt;">  TO_DATE(checkin_date, 'YYYY-MM-DD') AS checkin_date  -- 日付文字列を日付型に変換</span></div><div><span style="font-size: 10pt;">FROM reserve_tb</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 年/月/日/時刻/分/秒/曜日 への変換</span><span style="font-size: 10pt; font-weight: bold;">（sqliteでは</span><span style="font-size: 10pt; font-weight: bold;">TO_TIMESTAMP()とか無いから?</span><span style="font-size: 10pt; font-weight: bold;">実行できず</span><span style="font-size: 10pt; font-weight: bold;">）</span></div><div><span style="font-size: 10pt;">WITH tmp_log AS(</span></div><div><span style="font-size: 10pt;">    SELECT</span></div><div><span style="font-size: 10pt;">        CAST(</span></div><div><span style="font-size: 10pt;">      TO_TIMESTAMP(reserve_datetime, 'YYYY-MM-DD HH24:MI:SS') AS TIMESTAMP</span></div><div><span style="font-size: 10pt;">    ) AS reserve_datetime_timestamp,</span></div><div><span style="font-size: 10pt;">    FROM reserve_tb</span></div><div><span style="font-size: 10pt;">)</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    DATE_PART(year, reserve_datetime_timestamp) AS reserve_datetime_year,  -- 年を取得</span></div><div><span style="font-size: 10pt;">    DATE_PART(month, reserve_datetime_timestamp) AS reserve_datetime_month,  -- 月を取得</span></div><div><span style="font-size: 10pt;">    DATE_PART(day, reserve_datetime_timestamp) AS reserve_datetime_day,  -- 日を取得</span></div><div><span style="font-size: 10pt;">    DATE_PART(dow, reserve_datetime_timestamp) AS reserve_datetime_day,  -- 曜日(0 は日曜日、1＝月曜日)を取得</span></div><div><span style="font-size: 10pt;">    DATE_PART(hour, reserve_datetime_timestamp) AS reserve_datetime_hour,  -- 時刻の時を取得</span></div><div><span style="font-size: 10pt;">    DATE_PART(minute, reserve_datetime_timestamp) AS reserve_datetime_minute,  -- 時刻の分を取得</span></div><div><span style="font-size: 10pt;">    DATE_PART(second, reserve_datetime_timestamp) AS reserve_datetime_second,  -- 時刻の秒を取得</span></div><div><span style="font-size: 10pt;">    TO_CHAR(reserve_datetime_timestamp, 'YYYY-MM-DD HH24:MI:SS') AS reserve_datetime_char  -- 指定したフォーマットの文字列に変換</span></div><div><span style="font-size: 10pt;">FROM tmp_log</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 日時差の計算</span></div><div><span style="font-size: 10pt;">WITH tmp_log AS(</span></div><div><span style="font-size: 10pt;">  SELECT</span></div><div><span style="font-size: 10pt;">    CAST(TO_TIMESTAMP(reserve_datetime, 'YYYY-MM-DD HH24:MI:SS') AS TIMESTAMP) AS reserve_datetime,  -- reserve_datetimeをTIMESTAMP型へ変換</span></div><div><span style="font-size: 10pt;">    CAST(TO_TIMESTAMP(checkin_date || checkin_time, 'YYYY-MM-DDHH24:MI:SS') AS TIMESTAMP) AS checkin_datetime  -- checkin_datetimeをTIMESTAMP型へ変換</span></div><div><span style="font-size: 10pt;">  FROM reserve_tb</span></div><div><span style="font-size: 10pt;">)</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">    DATEDIFF(year, reserve_datetime, checkin_datetime) AS diff_year,  -- 年の差を計算（月以下の日時要素は考慮しない）</span></div><div><span style="font-size: 10pt;">    DATEDIFF(month, reserve_datetime, checkin_datetime) AS diff_month,  -- 月の差を取得（日以下の日時要素は考慮しない）</span></div><div><span style="font-size: 10pt;">    DATEDIFF(day, reserve_datetime, checkin_datetime) AS diff_day,  -- 日の差分を計算（時間以下の日時要素は考慮しない）</span></div><div><span style="font-size: 10pt;">    DATEDIFF(hour, reserve_datetime, checkin_datetime) AS diff_hour,  -- 時の差分を計算（分以下の日時要素は考慮しない）</span></div><div><span style="font-size: 10pt;">    DATEDIFF(minute, reserve_datetime, checkin_datetime) AS diff_minute,  -- 分の差分を計算（秒以下の日時要素は考慮しない）</span></div><div><span style="font-size: 10pt;">    CAST(DATEDIFF(second, reserve_datetime, checkin_datetime) AS FLOAT) / (60 * 60 * 24) AS diff_day2,  -- 日単位で差分を計算</span></div><div><span style="font-size: 10pt;">    CAST(DATEDIFF(second, reserve_datetime, checkin_datetime) AS FLOAT) / (60 * 60) AS diff_hour2,  -- 時間単位で差分を計算</span></div><div><span style="font-size: 10pt;">    CAST(DATEDIFF(second, reserve_datetime, checkin_datetime) AS FLOAT) / 60 AS diff_minute2,  -- 分単位で差分を計算</span></div><div><span style="font-size: 10pt;">    DATEDIFF(second, reserve_datetime, checkin_datetime) AS diff_second  -- 秒単位で差分を計算</span></div><div><span style="font-size: 10pt;">FROM tmp_log</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 季節に変換</span></font></div><div>WITH tmp_log AS(</div><div>  SELECT</div><div>    -- reserve_datetimeをTIMESTAMP型へ変換し、月を取得</div><div>    DATE_PART(</div><div>      month,</div><div>      CAST(</div><div>        TO_TIMESTAMP(reserve_datetime, 'YYYY-MM-DD HH24:MI:SS') AS TIMESTAMP</div><div>      )</div><div>    ) AS reserve_month</div><div>  FROM reserve_tb</div><div>)</div><div>SELECT</div><div>  CASE</div><div>    -- 月が3以上5以下の場合、springを返す</div><div>    WHEN 3 &lt;= reserve_month and reserve_month &lt;= 5 THEN 'spring'</div><div>    -- 月が6以上8以下の場合、springを返す</div><div>    WHEN 6 &lt;= reserve_month and reserve_month &lt;= 8 THEN 'summer'</div><div>    -- 月が9以上11以下の場合、autumnを返す</div><div>    WHEN 9 &lt;= reserve_month and reserve_month &lt;= 11 THEN 'autumn'</div><div>    -- 上記の全てに当てはまらない場合（月が1,2,12の場合）、winterを返す</div><div>    ELSE 'winter' END</div><div>  AS reserve_season</div><div>FROM tmp_log</div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">--# 平日/休日への変換</span></font></div><div>SELECT</div><div>    base.*,</div><div>    -- 休日フラグを付与(TRUE/FALSE)</div><div>    mst.holidayday_flg,</div><div>    -- 休日フラグを付与(TRUE/FALSE)</div><div>    mst.nextday_is_holiday_flg</div><div>FROM reserve_tb AS base</div><div>-- 休日マスタと結合</div><div>INNER JOIN holiday_mst_tb AS mst</div><div>  ON base.checkin_date = mst.target_day</div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 積集合</span></div><div><span style="font-size: 10pt;">SELECT ＊FROM table1</span></div><div><span style="font-size: 10pt;">INTERSECT</span></div><div><span style="font-size: 10pt;">SELECT * FROM tabel2</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# 差集合</span></div><div><span style="font-size: 10pt;">SELECT * FROM table1</span></div><div><span style="font-size: 10pt;">MINUS--(EXEPT:MYSQLとかではEXEPT)</span></div><div><span style="font-size: 10pt;">SELECT * FRPM table2</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--# ウィンドウ関数（集合関数 OVER (PARTITION BY キー)  GROUP BY で集合操作省いた処理実行する）</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">     col1</span></div><div><span style="font-size: 10pt;">,    COUNT(*) OVER (PARTITON BY col1)</span></div><div><span style="font-size: 10pt;">FROM table</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--ランキング</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">     col1</span></div><div><span style="font-size: 10pt;">,    RANK(*) OVER (PARTITON BY col1 DESC)</span></div><div><span style="font-size: 10pt;">FROM table</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--ランキング（抜け番なし）</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">     name</span></div><div><span style="font-size: 10pt;">,    age</span></div><div><span style="font-size: 10pt;">,    DENSE_RANK() OVER (PARTITON BY age DESC) AS dense_rnk</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">     table</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--ウィンドウ関数＋CASE式</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">     pref</span></div><div><span style="font-size: 10pt;">,    SUM(CASE WHEN sex = '1' THEN pop ELSE 0 END) AS pop_men</span></div><div><span style="font-size: 10pt;">,    SUM(CASE WHEN sex = '2' THEN pop ELSE 0 END) AS pop_wom</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">     Population</span></div><div><span style="font-size: 10pt;">GROUP BY</span></div><div><span style="font-size: 10pt;">     pref</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--ウィンドウ関数で「1行前の会社名」と「1行前の売り上げ」取得</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">     company</span></div><div><span style="font-size: 10pt;">,    year</span></div><div><span style="font-size: 10pt;">,    sale</span></div><div><span style="font-size: 10pt;">,    MAX(company) OVER (PARTITION BY    </span></div><div><span style="font-size: 10pt;">                                                company</span></div><div><span style="font-size: 10pt;">                                           ORDER BY</span></div><div><span style="font-size: 10pt;">                                                yesr</span></div><div><span style="font-size: 10pt;">                                            ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING</span></div><div><span style="font-size: 10pt;">                                          ) AS pre_company</span></div><div><span style="font-size: 10pt;">,    MAX(sale) OVER (PARTITION BY    </span></div><div><span style="font-size: 10pt;">                                       company</span></div><div><span style="font-size: 10pt;">                                  ORDER BY</span></div><div><span style="font-size: 10pt;">                                       yesr</span></div><div><span style="font-size: 10pt;">                                  ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING</span></div><div><span style="font-size: 10pt;">                                  ) AS pre_sale</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--連番振る</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">     id</span></div><div><span style="font-size: 10pt;">,    ROW_NUMBER() OVER (PARTITION BY id) AS seq</span></div><div><span style="font-size: 10pt;">FROM table</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--中央値求める（両端から1行ずつ数えてぶつかったとこ）</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">     AVG(weight) AS median</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">     (SELECT</span></div><div><span style="font-size: 10pt;">          weight</span></div><div><span style="font-size: 10pt;">,         ROW_NUMBER() OVER (ORDER BY weight ASC, id ASC) AS hi</span></div><div><span style="font-size: 10pt;">,         ROW_NUMBER() OVER (ORDER BY weight DESC, id DESC) AS lo </span></div><div><span style="font-size: 10pt;">       FROM</span></div><div><span style="font-size: 10pt;">          weight_tbl</span></div><div><span style="font-size: 10pt;">     ) TMP</span></div><div><span style="font-size: 10pt;">WHERE</span></div><div><span style="font-size: 10pt;">     hi IN (lo, lo+1, lo -1)</span></div><div><span style="font-size: 10pt;">;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--ナンバリングによりテーブル分割（連番の欠番のところで分割）</span></div><div><span style="font-size: 10pt;"> SELECT</span></div><div><span style="font-size: 10pt;">     num +1 AS gap_start</span></div><div><span style="font-size: 10pt;">,    '~'</span></div><div><span style="font-size: 10pt;">,    (num + diff -1) AS gap_end</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">     (SELECT</span></div><div><span style="font-size: 10pt;">          num</span></div><div><span style="font-size: 10pt;">      ,   MAX(num) OVER (ORDER BY num</span></div><div><span style="font-size: 10pt;">                                             ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING) - num</span></div><div><span style="font-size: 10pt;">      FROM</span></div><div><span style="font-size: 10pt;">          number_tbl</span></div><div><span style="font-size: 10pt;">     ) TMP(num, diff)</span></div><div><span style="font-size: 10pt;">WHERE</span></div><div><span style="font-size: 10pt;">     diff &lt;&gt; 1</span></div><div><span style="font-size: 10pt;">;</span></div><div><hr/></div><div><span style="font-size: 10pt;">20180507</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">ヒストグラム</span></div><div><span style="font-size: 10pt; font-weight: bold;">--0～0.9 を9つの区間に分けて属するグループ番号を返す</span></div><div><span style="font-size: 10pt; font-weight: bold;">※この場合、0.9以上は全て指定した区間の数＋１になる</span></div><div><span style="font-size: 10pt; font-weight: bold;">ので１つ減らした区間を設定するのがポイント</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">TBL.ID</span></div><div><span style="font-size: 10pt;">WIDTH_BUCKET(TBL.VALUE, 0/*min*/, 100/*max*/, 9/*num_buckets*/)</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">HOGE TBL</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--階層問い合わせ</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">CONNECT_BY_ROOT TBL.PARENT_ID ROOT_ID</span></div><div><span style="font-size: 10pt;">, TBL.CHILD_TYPE</span></div><div><span style="font-size: 10pt;">, TBL.CHILD_ID</span></div><div><span style="font-size: 10pt;">, SYS_CONNECT_BY_PATH( TBL.PARENT_ID, '/') || '/' || CHILD_ID ID_PATH</span></div><div><span style="font-size: 10pt;">, LEVEL DISTANCE</span></div><div><span style="font-size: 10pt;">, CONNECT_BY_ISLEAF IS_LEAF</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">HOGE TBL</span></div><div><span style="font-size: 10pt;">START WITH</span></div><div><span style="font-size: 10pt;">TBL.PARENT_ID IS NULL</span></div><div><span style="font-size: 10pt;">CONNECT BY /* NOCYCLE */</span></div><div><span style="font-size: 10pt;">PRIOR TBL.ID = TBL.PARENT_ID</span></div><div><span style="font-size: 10pt;">(親のテーブル) （子のテーブル）</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--完全外部結合</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">TBL1.ID</span></div><div><span style="font-size: 10pt;">, TBL1.VALUE</span></div><div><span style="font-size: 10pt;">, TBL2.ID</span></div><div><span style="font-size: 10pt;">, TBL2.VALUE</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">TBL1</span></div><div><span style="font-size: 10pt;">FULL OUTER JOIN</span></div><div><span style="font-size: 10pt;">TBL2</span></div><div><span style="font-size: 10pt;">ON</span></div><div><span style="font-size: 10pt;">TBL1.ID = TBL2.ID</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--クロス集計</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">*</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">TBL</span></div><div><span style="font-size: 10pt;">PIVOT(</span></div><div><span style="font-size: 10pt;">COUNT(*)</span></div><div><span style="font-size: 10pt;">FOR</span></div><div><span style="font-size: 10pt;">/* TBL名を使えないので注意 */</span></div><div><span style="font-size: 10pt;">TYPE IN (</span></div><div><span style="font-size: 10pt;">'AAA' AS COL1 /* 名前付けれる */</span></div><div><span style="font-size: 10pt;">, 'BBB' AS COL2</span></div><div><span style="font-size: 10pt;">, 'CCC' AS COL3</span></div><div><span style="font-size: 10pt;">)</span></div><div><span style="font-size: 10pt;">)</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--CLOB表示</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">DBMS_LOB.SUBSTR( TBL.VALUE, 200, 1 )</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">TBL</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--グループごとの順位</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">TBL.*</span></div><div><span style="font-size: 10pt;">, RANK() OVER(PARTITION BY TBL.TYPE ORDER BY TBL.ID)</span></div><div><span style="font-size: 10pt;">, DENSE_RANK() OVER(PARTITION BY TBL.TYPE ORDER BY TBL.ID) /* 同じ値の場合順位を飛ばさない */</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">TBL</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--左側を０埋め</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">LPAD( TBL.ID, 9, 0 ) /* 列, 桁数, 埋め込み文字 */</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">TBL</span></div><div><span style="font-size: 10pt;">/</span></div><div><span style="font-size: 10pt;">LISTAGG</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">TBL.ID</span></div><div><span style="font-size: 10pt;">, LISTAGG( TBL.VALUE, '/' ) WITHIN GROUP( ORDER BY TBL.ID ) VALUES</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">TBL</span></div><div><span style="font-size: 10pt;">GROUP BY TBL.ID</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--統計情報の更新</span></div><div><span style="font-size: 10pt;">BEGIN</span></div><div><span style="font-size: 10pt;">DBMS_STATS.GATHER_TABLE_STATS(</span></div><div><span style="font-size: 10pt;">OWNNAME =&gt; 'スキーマ名'</span></div><div><span style="font-size: 10pt;">, TABNAME =&gt; 'テーブル名'</span></div><div><span style="font-size: 10pt;">, ESTIMATE_PERCENT =&gt; 65</span></div><div><span style="font-size: 10pt;">, DEGREE =&gt; 2</span></div><div><span style="font-size: 10pt;">, METHOD_OPT =&gt; 'FOR ALL INDEXED COLUMNS SIZE AUTO'</span></div><div><span style="font-size: 10pt;">, CASCADE =&gt; TRUE</span></div><div><span style="font-size: 10pt;">);</span></div><div><span style="font-size: 10pt;">END;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--INDEXの作成</span></div><div><span style="font-size: 10pt;">CREATE [UNIQUE | BITMAP] INDEX &lt;インデックス名&gt; ON &lt;テーブル名&gt;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--INDEXの更新</span></div><div><span style="font-size: 10pt;">ALTER INDEX TBL_IDX1 REBUILD;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--MV更新</span></div><div><span style="font-size: 10pt;">EXEC DBMS_MVIEW.REFRESH('MV名', 'c', NULL, TRUE, FALSE, 1, 0, 0, FALSE, FALSE);</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--テーブル構造の取得</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">*</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">ALL_TAB_COLUMNS</span></div><div><span style="font-size: 10pt;">WHERE</span></div><div><span style="font-size: 10pt;">OWNER = 'me'</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--参照権限付与</span></div><div><span style="font-size: 10pt;">GRANT SELECT ON TABLE_NAME TO USER_NAME /* WITH GRANT OPTION */</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--ユーザ定義集計関数</span></div><div><span style="font-size: 10pt;">http://otndnld.oracle.co.jp/document/products/oracle10g/102/doc_cd/appdev.102/B19251-02/dciaggfns.htm</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--先頭文字だけ大文字変換</span></div><div><span style="font-size: 10pt;">SELECT</span></div><div><span style="font-size: 10pt;">INITCAP('abc def') -- Abc Def になる</span></div><div><span style="font-size: 10pt;">FROM</span></div><div><span style="font-size: 10pt;">dual</span></div><div><span style="font-size: 10pt;">/</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--条件に基づいたレコードのロード</span></div><div><span style="font-size: 10pt;">http://docs.oracle.com/cd/E16338_01/server.112/b56303/ldr_control_file.htm#i1005657</span></div><div><span style="font-size: 10pt;">WHEN句を使用して論理レコード中の条件をテストし、その論理レコードをロードするか廃棄するかを選択できます。</span></div><div><span style="font-size: 10pt;">たとえば、次のように指定すると、第5列の値がqであるレコードがすべてロードされます。</span></div><div><span style="font-size: 10pt;">LOAD DATA</span></div><div><span style="font-size: 10pt;">INFILE 'sample.dat'</span></div><div><span style="font-size: 10pt;">BADFILE 'sample.bad'</span></div><div><span style="font-size: 10pt;">DISCARDFILE 'sample.dsc'</span></div><div><span style="font-size: 10pt;">APPEND</span></div><div><span style="font-size: 10pt;">INTO TABLE emp</span></div><div><span style="font-size: 10pt;">WHEN (5) = 'q'</span></div><div><span style="font-size: 10pt;">TRAILING NULLCOLS</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt;">WHEN句では各条件の前にANDを使用して、複数の条件を設定できます。小カッコの指定は任意ですが、ANDによって複数の条件を設定している場合は、あいまいさを避けるために必ず使用してください。次に例を示します。</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt;">WHEN (deptno = '10') AND (job = 'SALES')</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--PL/SQL のエスケープ文字</span></div><div><span style="font-size: 10pt;">http://www.shift-the-oracle.com/plsql/escape-sequence-string.html</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--文字 アスキーコード表記 補足</span></div><div><span style="font-size: 10pt;">タブ CHR(9) \t 相当</span></div><div><span style="font-size: 10pt;">CR CHR(13) \r 相当 (CTRL+M)</span></div><div><span style="font-size: 10pt;">LF CHR(10) \n 相当 (CTRL+J)</span></div><div><span style="font-size: 10pt;">改行 CHR(13) || CHR(10) Windows プラットホーム</span></div><div><span style="font-size: 10pt;">CHR(10) UNIX、LINUX 系プラットホーム</span></div><div><span style="font-size: 10pt;">スペース CHR(32)</span></div><div><span style="font-size: 10pt;">引用符(') CHR(39)</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--テーブルや列のコメント</span></div><div><span style="font-size: 10pt;">http://www.ne.jp/asahi/hishidama/home/tech/oracle/table.html#h_comment</span></div><div><span style="font-size: 10pt;">comment on table テーブル名 is 'コメント';</span></div><div><span style="font-size: 10pt;">comment on column テーブル名.項目名 is 'コメント';</span></div><div><span style="font-size: 10pt;">※viewの場合もcomment on table でOK!</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--圧縮表の作成</span></div><div><span style="font-size: 10pt;">CREATE [GLOBAL TEMPORARY] TABLE [schema.]table</span></div><div><span style="font-size: 10pt;">(column datatype</span></div><div><span style="font-size: 10pt;">[SORT]</span></div><div><span style="font-size: 10pt;">[DEFAULT expr]</span></div><div><span style="font-size: 10pt;">[inline_constraint　[inline_constraint　…]]</span></div><div><span style="font-size: 10pt;">[, column datatype</span></div><div><span style="font-size: 10pt;">[SORT]</span></div><div><span style="font-size: 10pt;">[DEFAULT expr]</span></div><div><span style="font-size: 10pt;">[inline_constraint [inline_constraint …]] …</span></div><div><span style="font-size: 10pt;">]</span></div><div><span style="font-size: 10pt;">)</span></div><div><span style="font-size: 10pt;">[out_of_line_constraint [out_of_line_constraint …]]</span></div><div><span style="font-size: 10pt;">[ON COMMIT {DELETE | PRESERVE} ROWS]</span></div><div><span style="font-size: 10pt;">[PCTFREE integer]</span></div><div><span style="font-size: 10pt;">[PCTUSED integer]</span></div><div><span style="font-size: 10pt;">[INITRANS integer]</span></div><div><span style="font-size: 10pt;">[STORAGE (storage　[storage …])]</span></div><div><span style="font-size: 10pt;">[TABLESPACE tablespace]</span></div><div><span style="font-size: 10pt;">[LOGGING | NOLOGGING]</span></div><div><span style="font-size: 10pt;">[COMPRESS | NOCOMPRESS];</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--実行計画を取得する</span></div><div><a href="http://www.shift-the-oracle.com/sql/explain-plan.html" style="font-size: 10pt;">http://www.shift-the-oracle.com/sql/explain-plan.html</a></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt;">EXPLAIN PLAN FOR select * from hoge;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt;">で確認したいSQLを実行してから次のSQLで確認できるが、結果はテキストになってしまう。</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt;">SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><span style="font-size: 10pt;">PLAN_TABLE_OUTPUT</span></div><div><span style="font-size: 10pt;">------------------------------------------------------------------------------------</span></div><div><span style="font-size: 10pt;">Plan hash value: 2883659879</span></div><div><span style="font-size: 10pt;">------------------------------------------------------------------------------</span></div><div><span style="font-size: 10pt;">| Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time |</span></div><div><span style="font-size: 10pt;">------------------------------------------------------------------------------</span></div><div><span style="font-size: 10pt;">| 0 | SELECT STATEMENT | | 100K| 95M| 10770 (1)| 00:01:54 |</span></div><div><span style="font-size: 10pt;">| 1 | TABLE ACCESS FULL| JOIN_BIG | 100K| 95M| 10770 (1)| 00:01:54 |</span></div><div><span style="font-size: 10pt;">------------------------------------------------------------------------------</span></div><div><span style="font-size: 10pt;">8行が選択されました。</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 10pt; font-weight: bold;">--参照先のテーブルを取得するだけなら、PLAN_TABLEから取得できる。</span></div><div><span style="font-size: 10pt;">SELECT OBJECT_OWNER, OBJECT_NAME, OBJECT_TYPE FROM PLAN_TABLE;</span></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div><div><font style="font-size: 10pt;"><br clear="none"/></font></div></div><div><br/></div></span>
</div></body></html> 