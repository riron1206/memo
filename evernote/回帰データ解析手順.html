<html>
<head>
  <title>Evernote Export</title>
  <basefont face="メイリオ" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308919 (ja-JP, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: メイリオ;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="921"/>

<div>
<span><div><div><font style="font-size: 10pt;">20190729</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">回帰データ解析手順</font></span></div><div><font style="font-size: 10pt;">Titanic Top 4% with ensemble modeling</font></div><div><a href="https://www.kaggle.com/yassineghouzam/titanic-top-4-with-ensemble-modeling/notebook"><font style="font-size: 10pt;">https://www.kaggle.com/yassineghouzam/titanic-top-4-with-ensemble-modeling/notebook</font></a></div><div><font style="font-size: 10pt;">より</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;">基本的に以下のパッケージ使う</font></div><div><font style="font-size: 10pt;">import pandas as pd</font></div><div><font style="font-size: 10pt;">import numpy as np</font></div><div><font style="font-size: 10pt;">import matplotlib.pyplot as plt</font></div><div><font style="font-size: 10pt;">import seaborn as sns</font></div><div><font style="font-size: 10pt;">%matplotlib inline</font></div><div><font style="font-size: 10pt;"><br/></font></div><hr/><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■前処理</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1    train/validation setからはずれ値削除</font></span></div><div><font style="font-size: 10pt;">def detect_outliers(df,n,features):</font></div><div><font style="font-size: 10pt;">    &quot;&quot;&quot;</font></div><div><font style="font-size: 10pt;">    特徴のデータフレームdfを取り、Tukey法に従ってn個を超える外れ値を含む観測値に対応するインデックスのリストを返します。</font></div><div><font style="font-size: 10pt;">    &quot;&quot;&quot;</font></div><div><font style="font-size: 10pt;">    from collections import Counter</font></div><div><font style="font-size: 10pt;">    </font></div><div><font style="font-size: 10pt;">    outlier_indices = []</font></div><div><font style="font-size: 10pt;">    </font></div><div><font style="font-size: 10pt;">    # iterate over features(columns)</font></div><div><font style="font-size: 10pt;">    for col in features:</font></div><div><font style="font-size: 10pt;">        # 1st quartile (25%)</font></div><div><font style="font-size: 10pt;">        Q1 = np.percentile(df[col], 25)</font></div><div><font style="font-size: 10pt;">        # 3rd quartile (75%)</font></div><div><font style="font-size: 10pt;">        Q3 = np.percentile(df[col],75)</font></div><div><font style="font-size: 10pt;">        # Interquartile range (IQR)</font></div><div><font style="font-size: 10pt;">        IQR = Q3 - Q1</font></div><div><font style="font-size: 10pt;">        </font></div><div><font style="font-size: 10pt;">        # outlier step</font></div><div><font style="font-size: 10pt;">        outlier_step = 1.5 * IQR</font></div><div><font style="font-size: 10pt;">        </font></div><div><font style="font-size: 10pt;">        # Determine a list of indices of outliers for feature col</font></div><div><font style="font-size: 10pt;">        outlier_list_col = df[(df[col] &lt; Q1 - outlier_step) | (df[col] &gt; Q3 + outlier_step )].index</font></div><div><font style="font-size: 10pt;">        </font></div><div><font style="font-size: 10pt;">        # append the found outlier indices for col to the list of outlier indices</font></div><div><font style="font-size: 10pt;">        outlier_indices.extend(outlier_list_col)</font></div><div><font style="font-size: 10pt;">        </font></div><div><font style="font-size: 10pt;">    # select observations containing more than 2 outliers</font></div><div><font style="font-size: 10pt;">    outlier_indices = Counter(outlier_indices)        </font></div><div><font style="font-size: 10pt;">    multiple_outliers = list( k for k, v in outlier_indices.items() if v &gt; n )</font></div><div><font style="font-size: 10pt;">    </font></div><div><font style="font-size: 10pt;">    return multiple_outliers   </font></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"># detect outliers from Age, SibSp , Parch and Fare</font></div><div><font style="font-size: 10pt;">Outliers_to_drop = detect_outliers(train,2,[&quot;Age&quot;,&quot;SibSp&quot;,&quot;Parch&quot;,&quot;Fare&quot;])</font></div><div><font style="font-size: 10pt;">display(train.loc[Outliers_to_drop]) # 外れ値の行表示</font></div><div><font style="font-size: 10pt;">train = train.drop(Outliers_to_drop, axis = 0).reset_index(drop=True)</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;">#######################################################################################</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">◎Feature analysis:特徴量や目的変数を可視化して特徴を把握する。欠損値がある場合欠損値を埋めて、や特徴量が歪んでる場合はlog10取る。</font></span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■Feature analysisのことはじめ</font></span></div><div><font style="font-size: 10pt;"><span style="font-weight: bold;">0<span>    データフレームの</span></span><b>「有効データ数」「データ型」「メモリ使用量」などの総合的な情報を表示</b></font></div><div><font style="font-size: 10pt;"><span>    </span>df.info()</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;"><br/></font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1    train+validation+test set（全データ縦積み）</font></span></div><div><font style="font-size: 10pt;">    dataset =  pd.concat(objs=[train, test], axis=0).reset_index(drop=True)</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">2    欠損値確認</font></span></div><div><font style="font-size: 10pt;">    dataset = dataset.fillna(np.nan)</font></div><div><font style="font-size: 10pt;">    dataset.isnull().sum()</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">3    データ数行確認</font></span></div><div><font style="font-size: 10pt;">    train.head()</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">4    各特徴量のデータ型確認</font></span></div><div><font style="font-size: 10pt;">    train.dtypes</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">5    各特徴量の統計値（最大、最小とか）確認</font></span></div><div><font style="font-size: 10pt;">    train.describe()</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■各特徴量のFeature analysis</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1    特徴量の欠損の要素数確認</font></span></div><div><font style="font-size: 10pt;">    dataset[&quot;Fare&quot;].isnull().sum()</font></div><div><font style="font-size: 10pt;">    →0より大きい場合、欠損埋める必要がある</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1.1    特徴量の欠損埋める</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">    →欠損値が多すぎる特徴量については、他の特徴量との相関を確認して埋める必要がある（Feature engineeringの範囲）</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">    　以下の操作は欠損値が少ない場合に適応する簡易措置</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">    欠損値を最も頻度の多い値で埋める</font></span></div><div><font style="font-size: 10pt;">        dataset[&quot;Embarked&quot;].value_counts() # 頻度確認</font></div><div><font style="font-size: 10pt;">        g = sns.countplot(x=&quot;Title&quot;,data=dataset) # 頻度可視化する場合はこれ</font></div><div><font style="font-size: 10pt;">        g = plt.setp(g.get_xticklabels(), rotation=45) # x軸名45度回転させる</font></div><div><font style="font-size: 10pt;">        dataset[&quot;Embarked&quot;] = dataset[&quot;Embarked&quot;].fillna(&quot;S&quot;)</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">    欠損値を中央値で埋める</font></span></div><div><font style="font-size: 10pt;">        dataset[&quot;Fare&quot;] = dataset[&quot;Fare&quot;].fillna(dataset[&quot;Fare&quot;].median())</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">    欠損値を0で埋める</font></span></div><div><font style="font-size: 10pt;">        dataset[&quot;Fare&quot;] = dataset[&quot;Fare&quot;].fillna(0)</font></div><div><font style="font-size: 10pt;">        </font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">2    特徴量の分布が歪んでないか（とある値に集まってないか）確認</font></span></div><div><font style="font-size: 10pt;">    g = sns.distplot(dataset[&quot;Fare&quot;], color=&quot;m&quot;, label=&quot;Skewness : %.2f&quot;%(dataset[&quot;Fare&quot;].skew()))</font></div><div><font style="font-size: 10pt;">    g = g.legend(loc=&quot;best&quot;)</font></div><div><font style="font-size: 10pt;">    →歪み（スキュー）を減らすために対数関数を使用して変換するのが適切</font></div><div><font style="font-size: 10pt;">    dataset[&quot;Fare&quot;] = dataset[&quot;Fare&quot;].map(lambda i: np.log(i) if i &gt; 0 else 0)</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■目的変数と各特徴量のFeature analysis</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1.1    目的変数（0,1みたいな離散値）と数値データの各特徴量の相関行列のヒートマップ確認</font></span></div><div><font style="font-size: 10pt;">    g = sns.heatmap(train[[&quot;Survived&quot;,&quot;SibSp&quot;,&quot;Parch&quot;,&quot;Age&quot;,&quot;Fare&quot;]].corr(),annot=True, fmt = &quot;.2f&quot;, cmap = &quot;coolwarm&quot;)</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1.2    目的変数と各特徴量の分布を可視化</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1.2.1    目的変数が（0,1みたいな）離散値で、特徴量のユニークな要素が10以下の場合（性別とか）、2要素の割合を棒グラフで可視化</font></span></div><div><font style="font-size: 10pt;">        display(train[[&quot;SibSp&quot;,&quot;Survived&quot;]].groupby('SibSp').mean()) # 棒グラフの数値（割合）表示</font></div><div><font style="font-size: 10pt;">        g = sns.barplot(x=&quot;SibSp&quot;,y=&quot;Survived&quot;,data=train)</font></div><div><font style="font-size: 10pt;">        or</font></div><div><font style="font-size: 10pt;">        display(train[[&quot;SibSp&quot;,&quot;Survived&quot;]].groupby('SibSp').mean()) # 棒グラフの数値（割合）表示</font></div><div><font style="font-size: 10pt;">        g = sns.factorplot(x=&quot;SibSp&quot;,y=&quot;Survived&quot;,data=train, kind=&quot;bar&quot;, size=6 ,palette=&quot;muted&quot;)</font></div><div><font style="font-size: 10pt;">        g.despine(left=True)</font></div><div><font style="font-size: 10pt;">        g = g.set_ylabels(&quot;survival probability&quot;)</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1.2.1.1    目的変数が（0,1みたいな）離散値で、特徴量のユニークな要素が10以下の場合（性別とか）、3要素（1要素は凡例になる）の割合を棒グラフで可視化</font></span></div><div><font style="font-size: 10pt;">        display(train[[&quot;SibSp&quot;,&quot;Survived&quot;,&quot;Sex&quot;]].groupby('SibSp').mean()) # 棒グラフの数値（割合）表示</font></div><div><font style="font-size: 10pt;">        g = sns.factorplot(x=&quot;Pclass&quot;, y=&quot;Survived&quot;, hue=&quot;Sex&quot;, data=train, size=6, kind=&quot;bar&quot;, palette=&quot;muted&quot;)</font></div><div><font style="font-size: 10pt;">        g.despine(left=True) # y軸の線無くす</font></div><div><font style="font-size: 10pt;">        g = g.set_ylabels(&quot;survival probability&quot;)</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1.2.2    目的変数が（0,1みたいな）離散値で特徴量のユニークな要素が11以上の場合（年齢とか）、2要素の度数分布を可視化</font></span></div><div><font style="font-size: 10pt;">        g = sns.FacetGrid(train, col='Survived')</font></div><div><font style="font-size: 10pt;">        g = g.map(sns.distplot, &quot;Age&quot;)</font></div><div><font style="font-size: 10pt;">        # 度数分布を重ねる場合</font></div><div><font style="font-size: 10pt;">        g = sns.kdeplot(train[&quot;Age&quot;][(train[&quot;Survived&quot;] == 0) &amp; (train[&quot;Age&quot;].notnull())], color=&quot;Red&quot;, shade = True)</font></div><div><font style="font-size: 10pt;">        g = sns.kdeplot(train[&quot;Age&quot;][(train[&quot;Survived&quot;] == 1) &amp; (train[&quot;Age&quot;].notnull())], ax =g, color=&quot;Blue&quot;, shade= True)</font></div><div><font style="font-size: 10pt;">        g.set_xlabel(&quot;Age&quot;)</font></div><div><font style="font-size: 10pt;">        g.set_ylabel(&quot;Frequency&quot;)</font></div><div><font style="font-size: 10pt;">        g = g.legend([&quot;Not Survived&quot;,&quot;Survived&quot;])</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■各特徴量同士のFeature analysis</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1.1    数値データの各特徴量の相関行列のヒートマップ確認</font></span></div><div><font style="font-size: 10pt;">    g = sns.heatmap(dataset[[&quot;Age&quot;,&quot;Sex&quot;,&quot;SibSp&quot;,&quot;Parch&quot;,&quot;Pclass&quot;]].corr(),cmap=&quot;BrBG&quot;,annot=True)</font></div><div><font style="font-size: 10pt;">    →相関が高い特徴量の行のmedianで欠損を埋めるときとかに使える</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1.2    各特徴量同士のboxplotやバイオリンplot確認</font></span></div><div><font style="font-size: 10pt;">    g = sns.factorplot(y=&quot;Age&quot;,x=&quot;Sex&quot;,data=dataset,kind=&quot;box&quot;)</font></div><div><font style="font-size: 10pt;">    g = sns.factorplot(y=&quot;Age&quot;,x=&quot;Sex&quot;,hue=&quot;Pclass&quot;, data=dataset,kind=&quot;box&quot;)</font></div><div><font style="font-size: 10pt;">    g = sns.factorplot(y=&quot;Age&quot;,x=&quot;Parch&quot;, data=dataset,kind=&quot;box&quot;)</font></div><div><font style="font-size: 10pt;">    g = sns.factorplot(y=&quot;Age&quot;,x=&quot;SibSp&quot;, data=dataset,kind=&quot;violin&quot;)</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■その他</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1    文字型のカテゴリデータの特徴量を数値(0,1とか)に変換</font></span></div><div><font style="font-size: 10pt;">    dataset[&quot;Sex&quot;] = dataset[&quot;Sex&quot;].map({&quot;male&quot;: 0, &quot;female&quot;:1})</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;">#######################################################################################</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">◎Feature engineering:モデルの精度向上に効くように、特徴量をより有効なカテゴリーデータに変形したり、複数の特徴量から新たな特徴量列を作ること</font></span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■特徴量2列合体して新たな特徴量作成</font></span></div><div><font style="font-size: 10pt;">    dataset[&quot;Fsize&quot;] = dataset[&quot;SibSp&quot;] + dataset[&quot;Parch&quot;] + 1</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■特徴量をカテゴリ分けして新たな特徴量作成</font></span></div><div><font style="font-size: 10pt;">    dataset['Single'] = dataset['Fsize'].map(lambda s: 1 if s == 1 else 0)</font></div><div><font style="font-size: 10pt;">    dataset['SmallF'] = dataset['Fsize'].map(lambda s: 1 if  s == 2  else 0)</font></div><div><font style="font-size: 10pt;">    dataset['MedF'] = dataset['Fsize'].map(lambda s: 1 if 3 &lt;= s &lt;= 4 else 0)</font></div><div><font style="font-size: 10pt;">    dataset['LargeF'] = dataset['Fsize'].map(lambda s: 1 if s &gt;= 5 else 0)</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">■特徴量ダミー変数化（one-hotのように列増やして0,1に変換する。ダミー化はフラグ立ってる行がすべて0になる。one-hotはフラグ立ってる行が1でそれ以外の行が0）</font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">下の場合はprefix=&quot;Em&quot;かつユニークな要素が[C,Q,S]の3種類なのでEm_C, Em_Q, Em_Sの列ができる</font></span></div><div><font style="font-size: 10pt;">    dataset = pd.get_dummies(dataset, columns = [&quot;Embarked&quot;], prefix=&quot;Em&quot;)</font></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-size: 14px;"><br/></span></div></div></span>
</div></body></html> 